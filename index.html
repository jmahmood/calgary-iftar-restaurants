<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Calgary Iftaar Box Directory</title>
  <!-- Google Fonts: Poppins for body and Great Vibes for calligraphy -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&family=Great+Vibes&display=swap" rel="stylesheet">
  <style>
    :root {
      --accent-color: #d4af37; /* Gold accent */
      --primary-color: #1b4d3e; /* Deep teal/green */
      --header-bg-start: #0a2e36;
      --header-bg-end: #1b4d3e;
    }
    body {
      margin: 0;
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(135deg, #e0f7fa, #ffffff);
    }
    header {
      background: linear-gradient(135deg, var(--header-bg-start), var(--header-bg-end));
      color: #fff;
      text-align: center;
      padding: 40px 20px;
      position: relative;
    }
    header h1 {
      margin: 0;
      font-size: 2.8em;
    }
    header p {
      margin: 10px 0 0;
      font-size: 1.2em;
    }
    .ramadan-greeting {
      font-family: 'Great Vibes', cursive;
      font-size: 2.5em;
      margin-top: 10px;
      color: var(--accent-color);
    }
    .crescent {
      position: absolute;
      top: 20px;
      right: 20px;
    }
    .crescent svg {
      width: 60px;
      height: 60px;
    }
    main {
      max-width: 900px;
      margin: 30px auto;
      background: #fff;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 6px 12px rgba(0,0,0,0.15);
    }
    /* Filter Section */
    .filter-section {
      margin-bottom: 30px;
    }
    .filter-section h2 {
      color: var(--primary-color);
      margin-bottom: 15px;
    }
    .filter-form {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 20px;
    }
    .filter-form label {
      font-weight: 500;
      display: block;
      margin-bottom: 5px;
    }
    .filter-form input[type="text"],
    .filter-form input[type="number"],
    .filter-form input[type="date"],
    .filter-form select {
      width: 100%;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 1em;
    }
    .filter-buttons {
      grid-column: 1 / -1;
      text-align: right;
    }
    .filter-buttons button {
      background: var(--primary-color);
      color: #fff;
      border: none;
      padding: 10px 15px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 1em;
      margin-left: 10px;
    }
    .filter-buttons button:hover {
      background: #15322b;
    }
    /* JSON Editor Section */
    .json-editor {
      margin-bottom: 30px;
    }
    .json-editor textarea {
      width: 100%;
      height: 200px;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-family: monospace;
      font-size: 0.9em;
      resize: vertical;
    }
    .json-editor .editor-buttons {
      margin-top: 10px;
      text-align: right;
    }
    .json-editor .editor-buttons button {
      background: var(--primary-color);
      color: #fff;
      border: none;
      padding: 8px 12px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.9em;
      margin-left: 10px;
    }
    .json-editor .editor-buttons button:hover {
      background: #15322b;
    }
    /* Card List Styles */
    .card-list {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
    }
    .card {
      background: #fafafa;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      overflow: hidden;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    .card:hover {
      transform: translateY(-5px);
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }
    .card img {
      width: 100%;
      height: auto;
    }
    .card-content {
      padding: 15px;
    }
    .card-content h3 {
      margin-top: 0;
      color: var(--primary-color);
    }
    .card-content p {
      margin: 5px 0;
      font-size: 0.9em;
    }
    .card-links {
      margin-top: 10px;
      font-size: 0.9em;
    }
    .card-links a {
      margin-right: 10px;
      text-decoration: none;
      color: var(--primary-color);
      background: #e0f7fa;
      padding: 5px 8px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-family: inherit;
    }
    .card-links a:hover {
      background: #b2ebf2;
    }
    /* Modal Editor Styles */
    .modal-editor {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: #fff;
      width: 90%;
      max-width: 500px;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      z-index: 100;
      display: none;
    }
    .modal-editor h2 {
      margin-top: 0;
      color: var(--primary-color);
    }
    .modal-editor form {
      display: grid;
      grid-template-columns: 1fr;
      gap: 10px;
    }
    .modal-editor form label {
      font-weight: 500;
    }
    .modal-editor form input[type="text"],
    .modal-editor form input[type="number"],
    .modal-editor form input[type="date"],
    .modal-editor form textarea,
    .modal-editor form select {
      width: 100%;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 0.9em;
      font-family: inherit;
    }
    .modal-editor form textarea {
      resize: vertical;
    }
    .modal-editor .editor-buttons {
      text-align: right;
      margin-top: 10px;
    }
    .modal-editor .editor-buttons button {
      background: var(--primary-color);
      color: #fff;
      border: none;
      padding: 8px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.9em;
      margin-left: 10px;
    }
    .modal-editor .editor-buttons button:hover {
      background: #15322b;
    }
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.4);
      z-index: 50;
      display: none;
    }
    footer {
      text-align: center;
      padding: 20px;
      font-size: 1.1em;
      color: var(--primary-color);
    }
  </style>
</head>
<body>
  <header>
    <h1>Calgary Iftaar Box Directory</h1>
    <p>Discover restaurants, their locations, and Ramadan specials available for takeout in Calgary</p>
    <div class="ramadan-greeting">رمضان كريم</div>
    <div class="crescent">
      <svg viewBox="0 0 50 50">
        <path d="M25,0 A25,25 0 1,0 25,50 A15,25 0 1,1 25,0" fill="var(--accent-color)"></path>
      </svg>
    </div>
  </header>
  <main>
    <!-- Filter Section -->
    <section class="filter-section">
      <h2>Filter Iftaar Offers</h2>
      <div class="filter-form">
        <div>
          <label for="filterCommunity">Community</label>
          <select id="filterCommunity">
            <option value="">All</option>
            <option value="Northwest">Northwest</option>
            <option value="Northeast">Northeast</option>
            <option value="Southwest">Southwest</option>
            <option value="Southeast">Southeast</option>
          </select>
        </div>
        <div>
          <label for="filterMeat">Type of Meat</label>
          <select id="filterMeat">
            <option value="">All</option>
            <option value="Beef">Beef</option>
            <option value="Lamb">Lamb</option>
            <option value="Chicken">Chicken</option>
            <option value="Vegetarian">Vegetarian</option>
            <option value="Beef, Chicken, Fish, Vegetarian">Mixed</option>
          </select>
        </div>
        <div>
          <label for="filterCuisine">Cuisine</label>
          <select id="filterCuisine">
            <option value="">All</option>
            <option value="Pakistani/Indian">Pakistani/Indian</option>
            <option value="Pak-Afghan Fusion">Pak-Afghan Fusion</option>
            <option value="Mexican">Mexican</option>
            <option value="Lebanese">Lebanese</option>
            <option value="Fusion">Fusion</option>
            <option value="Afghan">Afghan</option>
            <option value="Lebanese/Middle Eastern">Lebanese/Middle Eastern</option>
          </select>
        </div>
        <div>
          <label for="filterRestaurant">Restaurant Name</label>
          <input type="text" id="filterRestaurant" placeholder="Enter restaurant name">
        </div>
        <div>
          <label for="filterDistance">Max Distance (km)</label>
          <input type="number" id="filterDistance" placeholder="Enter max distance">
        </div>
        <div>
          <label for="filterPrice">Max Price ($)</label>
          <input type="number" id="filterPrice" placeholder="Enter max price">
        </div>
        <div>
          <label for="filterAvailability">Available on Date</label>
          <input type="date" id="filterAvailability">
        </div>
        <div class="filter-buttons">
          <button id="resetFilters">Reset Filters</button>
        </div>
      </div>
    </section>
    
    <!-- JSON Editor Section -->
    <section class="json-editor">
      <h2>Edit JSON Data</h2>
      <textarea id="jsonEditor"></textarea>
      <div class="editor-buttons">
        <button onclick="loadJsonData()">Load JSON</button>
        <button onclick="copyJsonData()">Copy JSON</button>
      </div>
    </section>
    
    <!-- Card List Section -->
    <section class="card-list" id="cardList">
      <!-- Restaurant/special cards will be displayed here -->
    </section>
  </main>
  <footer>
    <strike>&copy; 2025 Calgary Iftaar Box Directory.</strike>
    LOL, copyright sucks. Please copy and reuse – the code is available on Github under a CC BY-SA 4.0 license.
  </footer>
  
  <!-- Modal Editor for Inline Editing -->
  <div class="modal-overlay" id="modalOverlay"></div>
  <div class="modal-editor" id="modalEditor">
    <h2>Edit Iftaar Offer</h2>
    <form id="specialEditorForm">
      <!-- Special Details -->
      <label for="editBoxName">Special Name</label>
      <input type="text" id="editBoxName" oninput="updateCurrentSpecial()" required>
      
      <!-- Restaurant & Location Details -->
      <label for="editRestaurant">Restaurant Name</label>
      <input type="text" id="editRestaurant" oninput="updateCurrentSpecial()" required>
      
      <label for="editAddress">Address</label>
      <input type="text" id="editAddress" oninput="updateCurrentSpecial()" placeholder="e.g., 9036 46 St NE, Calgary, AB">
      
      <label for="editPhone">Phone</label>
      <input type="text" id="editPhone" oninput="updateCurrentSpecial()" placeholder="e.g., 403-555-1234">
      
      <label for="editWebsite">Website</label>
      <input type="text" id="editWebsite" oninput="updateCurrentSpecial()" placeholder="https://example.com">
      
      <label for="editCommunity">Community</label>
      <select id="editCommunity" oninput="updateCurrentSpecial()">
        <option value="">Select</option>
        <option value="Northwest">Northwest</option>
        <option value="Northeast">Northeast</option>
        <option value="Southwest">Southwest</option>
        <option value="Southeast">Southeast</option>
      </select>
      
      <label for="editLatitude">Latitude</label>
      <input type="number" id="editLatitude" oninput="updateCurrentSpecial()" step="0.0001" required>
      
      <label for="editLongitude">Longitude</label>
      <input type="number" id="editLongitude" oninput="updateCurrentSpecial()" step="0.0001" required>
      
      <!-- Special-Specific Details -->
      <label for="editMeatType">Type of Meat</label>
      <input type="text" id="editMeatType" oninput="updateCurrentSpecial()" placeholder="e.g., Beef, Chicken">
      
      <label for="editCuisine">Cuisine</label>
      <select id="editCuisine" oninput="updateCurrentSpecial()">
        <option value="">Select</option>
        <option value="Pakistani/Indian">Pakistani/Indian</option>
        <option value="Pak-Afghan Fusion">Pak-Afghan Fusion</option>
        <option value="Mexican">Mexican</option>
        <option value="Lebanese">Lebanese</option>
        <option value="Fusion">Fusion</option>
        <option value="Afghan">Afghan</option>
        <option value="Lebanese/Middle Eastern">Lebanese/Middle Eastern</option>
      </select>
      
      <label for="editPrice">Price ($)</label>
      <input type="number" id="editPrice" oninput="updateCurrentSpecial()" step="0.01" required>
      
      <label for="editDescription">Description</label>
      <textarea id="editDescription" oninput="updateCurrentSpecial()" rows="3"></textarea>
      
      <label for="editPhotoUrl">Photo URL</label>
      <input type="text" id="editPhotoUrl" oninput="updateCurrentSpecial()">
      
      <label for="editAvailableDays">Available Days (comma separated)</label>
      <input type="text" id="editAvailableDays" oninput="updateCurrentSpecial()" placeholder="e.g., Monday,Tuesday">
      
      <label for="editAvailableDate">Available Date</label>
      <input type="date" id="editAvailableDate" oninput="updateCurrentSpecial()">
      
      <label for="editReviewUrl">Review URL</label>
      <input type="text" id="editReviewUrl" oninput="updateCurrentSpecial()">
      
      <div class="editor-buttons">
        <button type="button" onclick="saveSpecial()">Save</button>
        <button type="button" onclick="closeEditor()">Close</button>
        <button type="button" id="deleteBtn" onclick="deleteSpecial()" style="display:none;">Delete</button>
      </div>
    </form>
  </div>
  
  <script>
    // New global data: an array of restaurants.
    let restaurants = [
      {
        id: 1,
        name: "Khan Baba Restaurant",
        locations: [
          {
            address: "9036 46 St NE, Calgary, AB T2J 4J7",
            phone: "403-455-9272",
            website: "https://www.khanbaba.ca",
            community: "Northeast",
            latitude: 51.134,
            longitude: -113.943
          }
        ],
        specials: [
          {
            id: 1,
            boxName: "Single Person Iftar Box",
            meatType: "Beef, Chicken, Vegetarian",
            cuisine: "Pakistani/Indian",
            price: 11.99,
            photoUrl: "https://placehold.co/300x200?text=Khan+Baba",
            description: "Date, Vegetarian Samosa + Pakora, Chicken Biryani, Channa chat, Spring roll. After 4 PM",
            availableDays: ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday"],
            reviewUrl: "https://www.khanbaba.ca"
          },
          {
            id: 101,
            boxName: "Two Person Iftar Box",
            meatType: "Beef, Chicken, Vegetarian",
            cuisine: "Pakistani/Indian",
            price: 11.99,
            photoUrl: "https://placehold.co/300x200?text=Khan+Baba",
            description: "Date, Vegetarian Samosa + Pakora, Chicken Biryani, Channa chat, Spring roll, Mutanjan. After 4 PM",
            availableDays: ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday"],
            reviewUrl: "https://www.khanbaba.ca"
          }
        ]
      },
      {
        id: 2,
        name: "Hyderabad House Canada",
        locations: [
          {
            address: "5120 47st NE, Unit 105, Calgary, AB, Canada, Alberta",
            phone: "(403) 453-2000",
            website: "https://www.facebook.com/hyderabadhousecanada",
            community: "Northeast",
            latitude: 51.140,  // approximate
            longitude: -113.930
          }
        ],
        specials: [
          {
            id: 110,
            boxName: "Chicken Biryani",
            meatType: "Chicken",
            cuisine: "Pakistani/Indian",
            price: 12.99,
            photoUrl: "https://placehold.co/300x200?text=Hyderabad+House",
            description: "Half Chicken Biryani, Haleem, Mango Delight.",
            availableDays: ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday"],
            reviewUrl: "https://www.khanbaba.ca"
          },
          {
            id: 111,
            boxName: "Goat Biryani",
            meatType: "Goat",
            cuisine: "Pakistani/Indian",
            price: 12.99,
            photoUrl: "https://placehold.co/300x200?text=Hyderabad+House",
            description: "Half Goat Biryani, Haleem, Mango Delight.",
            availableDays: ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday"],
            reviewUrl: "https://www.khanbaba.ca"
          },
          {
            id: 112,
            boxName: "Chicken Mandi",
            meatType: "Beef, Chicken, Goat, Vegetarian",
            cuisine: "Pakistani/Indian",
            price: 12.99,
            photoUrl: "https://placehold.co/300x200?text=Hyderabad+House",
            description: "Half Chicken Mandi, Haleem, Mango Delight.",
            availableDays: ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday"],
            reviewUrl: "https://www.khanbaba.ca"
          },
          {
            id: 113,
            boxName: "Goat Mandi",
            meatType: "Beef, Chicken, Goat, Vegetarian",
            cuisine: "Pakistani/Indian",
            price: 12.99,
            photoUrl: "https://placehold.co/300x200?text=Hyderabad+House",
            description: "Half Goat Biryani, Haleem, Mango Delight.",
            availableDays: ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday"],
            reviewUrl: "https://www.khanbaba.ca"
          },
        ]
      },
      {
        id: 3,
        name: "Kabob Fusion",
        locations: [
          {
            address: "3131 27 St NE, Calgary, AB T1Y 0P3",
            phone: "403-606-0707",
            website: "https://www.kabobfusion.com",
            community: "Northeast",
            latitude: 51.071,
            longitude: -113.991
          }
        ],
        specials: [
          {
            id: 2,
            boxName: "Iftar Box",
            meatType: "Beef, Chicken, Fish, Vegetarian",
            cuisine: "Afghan",
            price: 14.99,
            photoUrl: "https://placehold.co/300x200?text=Kabob+Fusion",
            description: "2 shish kabobs (choice of chicken or beef), chana chat, dates, Afghan rice, and fish pakora. *Call ahead* to place your order before you pickup",
            availableDays: ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday"],
            reviewUrl: "https://www.example.com/reviews/greendelight"
          }
        ]
      },
      {
        id: 4,
        name: "Royal Grill Kebab & Pizza",
        locations: [
          {
            address: "2741 17 Ave SW, Calgary, AB T3E 6K8",
            phone: "403-984-8877",
            website: "https://www.royalgrill.ca",
            community: "Southwest",
            latitude: 51.037,
            longitude: -114.137
          }
        ],
        specials: [
          {
            id: 6,
            boxName: "Chicken Biryani Platter",
            meatType: "Chicken, Beef, Lamb; Vegetarian sides",
            cuisine: "Pakistani/Indian",
            price: 29.99,
            photoUrl: "https://placehold.co/300x200?text=Royal+Grill+Iftar+Box",
            description: "No Ramadan specials, but a lot of platters on their website. Price is for their Mix BBQ Platter: Chicken Tikka (4 pcs), Chicken Malai Tikka (4 pcs), Beef Shish Kebab (2 pcs), Fish Tikka (3 pcs) served with chutney & mint sauce",
            availableDays: ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday"],
            reviewUrl: "https://www.example.com/reviews/royalgrill"
          }
        ]
      },
      {
        id: 5,
        name: "Karahi Boys",
        locations: [
          {
            address: "5455 Falsbridge Dr NE, Calgary, AB T1Y 5S3",
            phone: "403-555-6789",
            website: "https://karahiboys.com/calgary",
            community: "Northeast",
            latitude: 51.120,
            longitude: -113.954
          }
        ],
        specials: [
          {
            id: 7,
            boxName: "Ramadan Family Platter",
            meatType: "Chicken, Beef, Lamb; Vegetarian options",
            cuisine: "Pakistani/Indian",
            price: 79.99,
            photoUrl: "https://placehold.co/300x200?text=Karahi+Boys",
            description: "A comprehensive family platter featuring full Chicken Karahi, Dum Biryani, Seekh Kababs, Tikka Boti, samosas, gulab jamun, naans, dates, and chutney – perfect for sharing with 4–5 people.",
            availableDays: ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday"],
            reviewUrl: "https://www.example.com/reviews/karahiboys"
          }
        ]
      },
      {
        id: 6,
        name: "Mirchi",
        locations: [
          {
            address: "76 Westwinds Cres NE, Calgary, AB T2K 0H7",
            phone: "403-555-0123",
            website: "https://www.facebook.com/mirchicalgaryne/",
            community: "Northeast",
            latitude: 51.120,
            longitude: -113.955
          }
        ],
        specials: [
          {
            id: 8,
            boxName: "Mirchi Iftar Pack",
            meatType: "Beef, Chicken, Goat; Vegetarian options",
            cuisine: "Pakistani/Indian",
            price: 22.50,
            photoUrl: "https://placehold.co/300x200?text=Mirchi+Iftar+Pack",
            description: "A takeout iftaar pack offering a variety of dishes from Mirchi’s buffet – biryani, curries, naan, salad, dates, and dessert in separate compartments.",
            availableDays: ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday"],
            reviewUrl: "https://www.example.com/reviews/mirchi"
          }
        ]
      },
      {
        id: 7,
        name: "Villa Madina",
        locations: [
          {
            address: "Sunridge Mall, Calgary, AB",
            phone: "403-555-4567",
            website: "https://www.villamadina.ca",
            community: "Northeast",
            latitude: 51.074,
            longitude: -113.982
          }
        ],
        specials: [
          {
            id: 9,
            boxName: "Ramadan Family Meal Box",
            meatType: "Chicken (Shawarma), Beef (Donair), Falafel (Vegetarian)",
            cuisine: "Lebanese/Middle Eastern",
            price: 89.99,
            photoUrl: "https://placehold.co/300x200?text=Villa+Madina",
            description: "A Ramadan special family meal box featuring halal shawarma meats, rice, salad, pita, hummus and a complimentary drink – perfect for sharing.",
            availableDays: ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday"],
            reviewUrl: "https://www.example.com/reviews/villamadina"
          }
        ]
      }
    ];
    
    // Global variables to track which restaurant/special are being edited.
    let currentRestaurantIndex = -1;
    let currentSpecialIndex = -1;
    
    // Update JSON editor textarea with current restaurants data.
    function updateJsonEditor() {
      document.getElementById('jsonEditor').value = JSON.stringify(restaurants, null, 2);
    }
    
    // Load JSON from editor and update restaurants array.
    function loadJsonData() {
      try {
        const jsonData = document.getElementById('jsonEditor').value;
        restaurants = JSON.parse(jsonData);
        applyFilters();
        updateJsonEditor();
        alert("JSON data loaded successfully!");
      } catch (e) {
        alert("Error parsing JSON: " + e.message);
      }
    }
    
    // Copy JSON data from editor to clipboard.
    function copyJsonData() {
      const jsonText = document.getElementById('jsonEditor').value;
      navigator.clipboard.writeText(jsonText).then(() => {
        alert("JSON data copied to clipboard!");
      }).catch(err => {
        alert("Failed to copy JSON: " + err);
      });
    }
    
    // Get user's location for distance filtering.
    let userLocation = null;
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(function(position) {
        userLocation = {
          latitude: position.coords.latitude,
          longitude: position.coords.longitude
        };
        applyFilters();
      }, function(error) {
        console.error("Geolocation error:", error);
      });
    } else {
      console.error("Geolocation is not supported by this browser.");
    }
    
    // Filtering: loop through restaurants and for each, check restaurant-level filters,
    // then for each special, check its filters. For location-based filters we choose
    // the first location that matches (if any), otherwise the first location.
    function applyFilters() {
      const filterCommunity = document.getElementById('filterCommunity').value;
      const filterMeat = document.getElementById('filterMeat').value;
      const filterCuisine = document.getElementById('filterCuisine').value;
      const filterRestaurant = document.getElementById('filterRestaurant').value.trim().toLowerCase();
      const filterDistance = parseFloat(document.getElementById('filterDistance').value);
      const filterPrice = parseFloat(document.getElementById('filterPrice').value);
      const filterAvailability = document.getElementById('filterAvailability').value;
      
      const filteredCards = [];
      
      restaurants.forEach((restaurant, rIndex) => {
        // Restaurant name filter
        if (filterRestaurant && !restaurant.name.toLowerCase().includes(filterRestaurant)) {
          return;
        }
        // For location-based filters, try to pick a matching location if possible.
        let chosenLocation = restaurant.locations[0];
        if (filterCommunity || (!isNaN(filterDistance))) {
          const matchingLoc = restaurant.locations.find(loc => {
            let communityOk = true;
            let distanceOk = true;
            if (filterCommunity) {
              communityOk = (loc.community === filterCommunity);
            }
            if (!isNaN(filterDistance) && userLocation) {
              const dist = getDistance(userLocation.latitude, userLocation.longitude, loc.latitude, loc.longitude);
              distanceOk = (dist <= filterDistance);
            }
            return communityOk && distanceOk;
          });
          if (matchingLoc) {
            chosenLocation = matchingLoc;
          } else if (filterCommunity || (!isNaN(filterDistance))) {
            // If no location matches the filter, skip this restaurant.
            return;
          }
        }
        
        // For each special, apply special-specific filters.
        restaurant.specials.forEach((special, sIndex) => {
          if (filterMeat && special.meatType.indexOf(filterMeat) === -1) return;
          if (filterCuisine && special.cuisine !== filterCuisine) return;
          if (!isNaN(filterPrice) && special.price > filterPrice) return;
          if (filterAvailability) {
            const chosenDate = new Date(filterAvailability);
            const daysOfWeek = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];
            const chosenDayName = daysOfWeek[chosenDate.getDay()];
            if (special.availableDate) {
              if (special.availableDate !== filterAvailability) return;
            } else if (special.availableDays) {
              if (!special.availableDays.includes(chosenDayName)) return;
            }
          }
          filteredCards.push({restaurantIndex: rIndex, specialIndex: sIndex, location: chosenLocation});
        });
      });
      
      displayCards(filteredCards);
    }
    
    // Haversine formula to calculate distance in km.
    function getDistance(lat1, lon1, lat2, lon2) {
      const R = 6371;
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLon = (lon2 - lon1) * Math.PI / 180;
      const a = Math.sin(dLat / 2) ** 2 +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLon / 2) ** 2;
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return R * c;
    }
    
    // Returns a maps URL based on device.
    function getMapsLink(lat, lon) {
      const ua = navigator.userAgent;
      if (/iPad|iPhone|iPod/.test(ua) && !window.MSStream) {
        return `http://maps.apple.com/?ll=${lat},${lon}`;
      } else {
        return `https://www.google.com/maps/search/?api=1&query=${lat},${lon}`;
      }
    }
    
    // Display function: create a card for each filtered special.
    function displayCards(cards) {
      const cardList = document.getElementById('cardList');
      cardList.innerHTML = '';
      if (cards.length === 0) {
        cardList.innerHTML = '<p>No offers found. Try adjusting your filters.</p>';
        return;
      }
      cards.forEach(item => {
        const restaurant = restaurants[item.restaurantIndex];
        const special = restaurant.specials[item.specialIndex];
        const loc = item.location;
        const mapsLink = getMapsLink(loc.latitude, loc.longitude);
        let linksHTML = `<a href="${mapsLink}" target="_blank">Map</a>`;
        if (loc.website) {
          linksHTML += `<a href="${loc.website}" target="_blank">Site</a>`;
        }
        if (loc.phone) {
          linksHTML += `<a href="tel:${loc.phone}">Call</a>`;
        }
        if (special.reviewUrl) {
          linksHTML += `<a href="${special.reviewUrl}" target="_blank">Reviews</a>`;
        }
        linksHTML += `<br><a href="javascript:void(0)" onclick="editSpecial(${item.restaurantIndex}, ${item.specialIndex})">Edit</a>`;
    
        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `
          <img src="${special.photoUrl}" alt="${special.boxName}">
          <div class="card-content">
            <h3>${special.boxName}</h3>
            <p><strong>Restaurant:</strong> ${restaurant.name}</p>
            <p><strong>Address:</strong> ${loc.address}</p>
            <p><strong>Price:</strong> $${special.price}</p>
            <p>${special.description}</p>
            <div class="card-links">
              ${linksHTML}
            </div>
          </div>
        `;
        cardList.appendChild(card);
      });
    }
    
    // Modal Editor Functions
    function openEditor() {
      document.getElementById('modalEditor').style.display = "block";
      document.getElementById('modalOverlay').style.display = "block";
    }
    
    function closeEditor() {
      document.getElementById('modalEditor').style.display = "none";
      document.getElementById('modalOverlay').style.display = "none";
      currentRestaurantIndex = -1;
      currentSpecialIndex = -1;
    }
    
    // When editing, we update both restaurant (first location) and special fields.
    function editSpecial(rIndex, sIndex) {
      currentRestaurantIndex = rIndex;
      currentSpecialIndex = sIndex;
      const restaurant = restaurants[rIndex];
      const special = restaurant.specials[sIndex];
      // Use first location for editing restaurant location info.
      const loc = restaurant.locations[0] || {};
      
      document.getElementById('editBoxName').value = special.boxName || "";
      document.getElementById('editRestaurant').value = restaurant.name || "";
      document.getElementById('editAddress').value = loc.address || "";
      document.getElementById('editPhone').value = loc.phone || "";
      document.getElementById('editWebsite').value = loc.website || "";
      document.getElementById('editCommunity').value = loc.community || "";
      document.getElementById('editLatitude').value = loc.latitude || "";
      document.getElementById('editLongitude').value = loc.longitude || "";
      
      document.getElementById('editMeatType').value = special.meatType || "";
      document.getElementById('editCuisine').value = special.cuisine || "";
      document.getElementById('editPrice').value = special.price || "";
      document.getElementById('editDescription').value = special.description || "";
      document.getElementById('editPhotoUrl').value = special.photoUrl || "";
      document.getElementById('editAvailableDays').value = special.availableDays ? special.availableDays.join(",") : "";
      document.getElementById('editAvailableDate').value = special.availableDate || "";
      document.getElementById('editReviewUrl').value = special.reviewUrl || "";
      
      document.getElementById('deleteBtn').style.display = "inline-block";
      openEditor();
    }
    
    // Update the current special (and restaurant/location info) from modal fields.
    function updateCurrentSpecial() {
      if (currentRestaurantIndex === -1 || currentSpecialIndex === -1) return;
      const restaurant = restaurants[currentRestaurantIndex];
      const special = restaurant.specials[currentSpecialIndex];
      // Update restaurant info (affects all specials)
      restaurant.name = document.getElementById('editRestaurant').value.trim();
      const loc = restaurant.locations[0] || {};
      loc.address = document.getElementById('editAddress').value.trim();
      loc.phone = document.getElementById('editPhone').value.trim();
      loc.website = document.getElementById('editWebsite').value.trim();
      loc.community = document.getElementById('editCommunity').value;
      loc.latitude = parseFloat(document.getElementById('editLatitude').value) || 0;
      loc.longitude = parseFloat(document.getElementById('editLongitude').value) || 0;
      // If no location exists, create one.
      if (!restaurant.locations[0]) {
        restaurant.locations[0] = loc;
      }
      // Update special details.
      special.boxName = document.getElementById('editBoxName').value.trim();
      special.meatType = document.getElementById('editMeatType').value.trim();
      special.cuisine = document.getElementById('editCuisine').value;
      special.price = parseFloat(document.getElementById('editPrice').value) || 0;
      special.description = document.getElementById('editDescription').value.trim();
      special.photoUrl = document.getElementById('editPhotoUrl').value.trim();
      const daysText = document.getElementById('editAvailableDays').value.trim();
      special.availableDays = daysText ? daysText.split(",").map(s => s.trim()) : [];
      special.availableDate = document.getElementById('editAvailableDate').value;
      special.reviewUrl = document.getElementById('editReviewUrl').value.trim();
      
      applyFilters();
      updateJsonEditor();
    }
    
    function deleteSpecial() {
      if (currentRestaurantIndex > -1 && currentSpecialIndex > -1 && confirm("Are you sure you want to delete this offer?")) {
        restaurants[currentRestaurantIndex].specials.splice(currentSpecialIndex, 1);
        closeEditor();
        applyFilters();
        updateJsonEditor();
      }
    }
    
    function saveSpecial() {
      closeEditor();
      applyFilters();
      updateJsonEditor();
    }
    
    // Reset filters button
    document.getElementById('resetFilters').addEventListener('click', function() {
      document.getElementById('filterCommunity').value = "";
      document.getElementById('filterMeat').value = "";
      document.getElementById('filterCuisine').value = "";
      document.getElementById('filterRestaurant').value = "";
      document.getElementById('filterDistance').value = "";
      document.getElementById('filterPrice').value = "";
      document.getElementById('filterAvailability').value = "";
      applyFilters();
    });
    
    // Event listeners for filtering.
    document.getElementById('filterCommunity').addEventListener('change', applyFilters);
    document.getElementById('filterMeat').addEventListener('change', applyFilters);
    document.getElementById('filterCuisine').addEventListener('change', applyFilters);
    document.getElementById('filterRestaurant').addEventListener('input', applyFilters);
    document.getElementById('filterDistance').addEventListener('input', applyFilters);
    document.getElementById('filterPrice').addEventListener('input', applyFilters);
    document.getElementById('filterAvailability').addEventListener('input', applyFilters);
    
    // Initialize JSON editor and display cards on load.
    updateJsonEditor();
    applyFilters();
  </script>
</body>
</html>
